#!/bin/sh

DIR=$(dirname `readlink -f $0`)
TERMUX_BLD_DIR="$DIR/../../termux-packages"
DEBS_DIR="$DIR/../debs"
ARCH=arm
DOWNLOADABLE_DEB="swi-prolog_latest_arm.deb"

if [ x"$1" == x"-f" ]; then
   FORCE="-f"
fi

if [ ! -d "$TERMUX_BLD_DIR" ]; then
   echo "$TERMUX_BLD_DIR not found."
   echo
   echo "termux-packages repository doesn\'t exist, please run:"
   echo "   git clone https://github.com/erlanger/termux-packages"
   echo "in the parent directory of this repository."
fi
   
                        ######################
                        #   Build new debs   #
                        ######################
BUILD_CMD="env SWIPL_SRC=${SWIPL_SRC=\"\"} ./build-package.sh -a $ARCH $FORCE swi-prolog"
echo "$TERMUX_BLD_DIR/scripts/run-docker.sh"  $BUILD_CMD
"$TERMUX_BLD_DIR/scripts/run-docker.sh"  $BUILD_CMD


                     ##############################
                     #  Move debs to release repo #
                     ##############################
LAST_BUILT__DEB=`ls -rt1 ${TERMUX_BLD_DIR}/debs/swi-prolog*|tail -1`    && \
   cp "$LAST_BUILT__DEB" "$DEBS_DIR"                                    && \
   cd "$DEBS_DIR"                                                       && \
   rm -f "$DOWNLOADABLE_DEB"                                            && \
   cp -f "$LAST_BUILT__DEB" ./"$DOWNLOADABLE_DEB"
